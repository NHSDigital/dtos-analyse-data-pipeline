
---

name: $(Build.SourceBranchName)-$(Date:yyyyMMdd)_$(Rev:r)
trigger: none
pr: none

resources:
  repositories:
    - repository: dtos-devops-templates
      type: github
      name: NHSDigital/dtos-devops-templates
      ref: feat/DTOSS-9224-optimise-foundry-relay-for-high-volume-event-processing
      endpoint: NHSDigital

variables:
  - group: DEV_service_bulk_load

stages:
- stage: load_test_service_bus
  displayName: Load Test Service Bus
  jobs:
    - job: bulk_load_job
      displayName: Run Azure Bulk Load Script
      pool:
        vmImage: 'ubuntu-latest'
      steps:
        - checkout: self
        - checkout: dtos-devops-templates

        - task: UsePythonVersion@0
          inputs:
            versionSpec: '3.10'

        - script: |
            python -m pip install --upgrade pip
            # if [ -f scripts/azure/requirements.txt ]; then
            pip install azure-servicebus
            pip install azure
            pip install -r scripts/azure/requirements.txt
            # fi
          # workingDirectory: $(Build.SourcesDirectory)/dtos-devops-templates
          displayName: 'Install Python Dependencies'

        - script: |
            find .
            export SERVICE_BUS_CONNECTION_STR=$(SERVICE_BUS_CONNECTION_STR)
            echo $SERVICE_BUS_CONNECTION_STR
            python dtos-devops-templates/scripts/azure/azure_bulk_load.py \
              --topic events \
              --file dtos-analyse-data-pipeline/infrastructure/environments/cloud/data/audit_episodes_20250523.csv \
              --rows 50000 \
              --concurrency 2
          # workingDirectory: $(Build.SourcesDirectory)/dtos-devops-templates
          displayName: 'Run azure_bulk_load.py'